<!DOCTYPE html>
<html lang="uk" ng-app="app">
<head>
  <meta charset="UTF-8" />
  <!-- Прибрали maximum-scale та user-scalable, щоб не забороняти масштабування -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Заповнення заявки – кроки</title>
  
  <!-- Підключення AngularJS -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  
  <!-- Підключення Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <style>
    /* Прибрано будь-яке 100vh, фіксований фон тощо */
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      /* Звичайний фон без background-attachment: fixed */
      background: url('https://images.pexels.com/photos/730897/pexels-photo-730897.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=650&w=940')
        no-repeat center center;
      background-size: cover;
      color: #fff;
      text-align: center;
      height: auto;      /* дозволяємо адаптивну висоту */
      min-height: 100%;  /* щоб хоч трохи тягнулося донизу */
    }
    .overlay {
      /* Напівпрозорий шар поверх фону */
      background-color: rgba(0,0,0,0.5);
      /* Звичайне відображення (block або flex без жорсткого центр. по осі Y) */
      display: block;
      /* Дозволяємо прокрутку */
      overflow-y: auto;
      /* «Запас» знизу, щоб клавіатура не перекривала останні поля */
      padding: 20px 20px 150px 20px;
      box-sizing: border-box;
      min-height: 100%;  /* можна залишити 100%, але не 100vh */
    }
    .container {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;    /* центрування по горизонталі */
      box-sizing: border-box;
    }
    
    h2 {
      margin-bottom: 15px;
    }
    label {
      display: block;
      text-align: left;
      font-weight: bold;
      margin: 10px 0 5px;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: none;
      box-sizing: border-box;
      font-size: 16px;
    }
    button {
      background: #007bff;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s ease;
      border: none;
    }
    button:hover {
      background: #0056b3;
    }
    .hidden {
      display: none;
    }
    /* Контейнер для кнопок */
    .button-container {
      display: flex;
      justify-content: space-between;
    }
    .button-container button {
      width: 48%;
    }
    
    /* Стилі для директиви dropdownList (локація) */
    .dropdown-container {
      position: relative;
      text-align: left;
    }
    .dropdown-container input {
      background: #fff;
      color: #000;
    }
    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      color: #000;
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #ccc;
      z-index: 1000;
    }
    .dropdown-list div {
      padding: 8px;
      cursor: pointer;
    }
    .dropdown-list div:hover {
      background: #f0f0f0;
    }
    input::placeholder {
      color: rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="container">
      <!-- Крок 1: Основні дані -->
      <div id="page1">
        <h2>Крок 1: Основні дані</h2>
        <label for="fghName">Назва ФГ (не обов’язково):</label>
        <input type="text" id="fghName" placeholder="Введіть назву ФГ">
        
        <label for="edrpou">Код ЄДРПОУ (8 або 10 цифр, не обов’язково):</label>
        <input type="text" id="edrpou" placeholder="Введіть код ЄДРПОУ" pattern="^(\d{8}|\d{10})?$">
        
        <!-- Поля локації через AngularJS -->
        <div ng-controller="mainCtrl">
          <label>Область:</label>
          <dropdown-list data-items-list="regions" data-placeholder="Оберіть область" ng-model="selectedRegion"></dropdown-list>
          
          <label>Район:</label>
          <dropdown-list data-items-list="districts" data-placeholder="Оберіть район" ng-model="selectedDistrict"></dropdown-list>
          
          <label>Населений пункт:</label>
          <dropdown-list data-items-list="cities" data-placeholder="Оберіть місто" ng-model="selectedCity"></dropdown-list>
        </div>
        
        <button id="nextBtn1">Далі</button>
      </div>
      
      <!-- Крок 2: Деталі заявки -->
      <div id="page2" class="hidden" ng-controller="step2Ctrl">
        <h2>Крок 2: Деталі заявки</h2>
        <!-- Вибір групи -->
        <label for="groupSelect">Вибір групи:</label>
        <select id="groupSelect" ng-model="selectedGroup" required>
          <option value="">Оберіть групу</option>
          <option ng-repeat="group in groups" value="{{group}}">{{group}}</option>
        </select>
        
        <!-- Вибір культури -->
        <label for="cultureSelect">Вибір культури:</label>
        <select id="cultureSelect" ng-model="selectedCulture" required>
          <option value="">Оберіть культуру</option>
          <option ng-repeat="culture in cultures" value="{{culture}}">{{culture}}</option>
        </select>
        
        <!-- Блок додаткових полів (залежно від культури) -->
        <div ng-if="selectedCulture">
          <!-- Пшениця -->
          <div ng-if="selectedCulture.indexOf('Пшениця') !== -1">
            <label for="natura">Натура (Не обов'язково):</label>
            <input type="text" id="natura" ng-model="extraFields.natura" format-decimal placeholder="Наприклад, 12.3">
            <label for="bilok">Білок (Не обов'язково):</label>
            <input type="text" id="bilok" ng-model="extraFields.bilok" format-decimal placeholder="Наприклад, 12.3">
            <label for="kleikovina">Клейковина (Не обов'язково):</label>
            <input type="text" id="kleikovina" ng-model="extraFields.kleikovina" format-decimal placeholder="Наприклад, 12.3">
            <label for="smitteva">Сміттєва домішка (Не обов'язково):</label>
            <input type="text" id="smitteva" ng-model="extraFields.smitteva" format-decimal placeholder="Наприклад, 12.3">
            <label for="vologhist">Вологість (Не обов'язково):</label>
            <input type="text" id="vologhist" ng-model="extraFields.vologhist" format-decimal placeholder="Наприклад, 12.3">
            <label for="sazhkov">Сажкові зерна (Не обов'язково):</label>
            <input type="text" id="sazhkov" ng-model="extraFields.sazhkov" format-decimal placeholder="Наприклад, 12.3">
          </div>
          <!-- Ячмінь -->
          <div ng-if="selectedCulture.indexOf('Ячмінь') !== -1">
            <label for="natura_ya">Натура (Не обов'язково):</label>
            <input type="text" id="natura_ya" ng-model="extraFields.natura" format-decimal placeholder="Наприклад, 12.3">
            <label for="vologhist_ya">Вологість (Не обов'язково):</label>
            <input type="text" id="vologhist_ya" ng-model="extraFields.vologhist" format-decimal placeholder="Наприклад, 12.3">
            <label for="smitteva_ya">Сміттєва домішка (Не обов'язково):</label>
            <input type="text" id="smitteva_ya" ng-model="extraFields.smitteva" format-decimal placeholder="Наприклад, 12.3">
          </div>
          <!-- Кукурудза (без урахування регістру) -->
          <div ng-if="selectedCulture.toLowerCase().indexOf('кукуруд') !== -1">
            <label for="vologhist_k">Вологість (Не обов'язково):</label>
            <input type="text" id="vologhist_k" ng-model="extraFields.vologhist" format-decimal placeholder="Наприклад, 12.3">
            <label for="zernovadomishka">Зернова домішка (Не обов'язково):</label>
            <input type="text" id="zernovadomishka" ng-model="extraFields.zernovadomishka" format-decimal placeholder="Наприклад, 12.3">
            <label for="poshkodjeni">Пошкоджені зерна (Не обов'язково):</label>
            <input type="text" id="poshkodjeni" ng-model="extraFields.poshkodjeni" format-decimal placeholder="Наприклад, 12.3">
            <label for="smitteva_k">Сміттєва домішка (Не обов'язково):</label>
            <input type="text" id="smitteva_k" ng-model="extraFields.smitteva" format-decimal placeholder="Наприклад, 12.3">
            <label for="zipsovani">Зіпсовані зерна (Не обов'язково):</label>
            <input type="text" id="zipsovani" ng-model="extraFields.zipsovani" format-decimal placeholder="Наприклад, 12.3">
          </div>
          <!-- Соняшник -->
          <div ng-if="selectedCulture.indexOf('Соняшник') !== -1">
            <label for="olijnist_na_suhu">Олійність на суху (Не обов'язково):</label>
            <input type="text" id="olijnist_na_suhu" ng-model="extraFields.olijnist_na_suhu" format-decimal placeholder="Наприклад, 12.3">
            <label for="vologhist_son">Вологість (Не обов'язково):</label>
            <input type="text" id="vologhist_son" ng-model="extraFields.vologhist" format-decimal placeholder="Наприклад, 12.3">
            <label for="smitteva_son">Сміттєва домішка (Не обов'язково):</label>
            <input type="text" id="smitteva_son" ng-model="extraFields.smitteva" format-decimal placeholder="Наприклад, 12.3">
            <label for="kislotne">Кислотне число (Не обов'язково):</label>
            <input type="text" id="kislotne" ng-model="extraFields.kislotne" format-decimal placeholder="Наприклад, 12.3">
          </div>
          <!-- Ріпак -->
          <div ng-if="selectedCulture == 'Ріпак'">
            <label for="olijnist_na_siru">Олійність на сиру (Не обов'язково):</label>
            <input type="text" id="olijnist_na_siru" ng-model="extraFields.olijnist_na_siru" format-decimal placeholder="Наприклад, 12.3">
            <label for="vologhist_ripak">Вологість (Не обов'язково):</label>
            <input type="text" id="vologhist_ripak" ng-model="extraFields.vologhist" format-decimal placeholder="Наприклад, 12.3">
            <label for="glukozinolati">Глюкозінолати (Не обов'язково):</label>
            <input type="text" id="glukozinolati" ng-model="extraFields.glukozinolati" format-decimal placeholder="Наприклад, 12.3">
            <label for="smitteva_ripak">Сміттєва домішка (Не обов'язково):</label>
            <input type="text" id="smitteva_ripak" ng-model="extraFields.smitteva" format-decimal placeholder="Наприклад, 12.3">
          </div>
          <!-- Соя -->
          <div ng-if="selectedCulture == 'Соя'">
            <label for="bilok_na_siru">Білок на сиру (Не обов'язково):</label>
            <input type="text" id="bilok_na_siru" ng-model="extraFields.bilok_na_siru" format-decimal placeholder="Наприклад, 12.3">
            <label for="vologhist_soya">Вологість (Не обов'язково):</label>
            <input type="text" id="vologhist_soya" ng-model="extraFields.vologhist" format-decimal placeholder="Наприклад, 12.3">
            <label for="smitteva_soya">Сміттєва домішка (Не обов'язково):</label>
            <input type="text" id="smitteva_soya" ng-model="extraFields.smitteva" format-decimal placeholder="Наприклад, 12.3">
            <label for="olijna_domishka">Олійна домішка (Не обов'язково):</label>
            <input type="text" id="olijna_domishka" ng-model="extraFields.olijna_domishka" format-decimal placeholder="Наприклад, 12.3">
            <label for="ambrizia">Амброзія (Не обов'язково):</label>
            <input type="text" id="ambrizia" ng-model="extraFields.ambrizia" format-decimal placeholder="Наприклад, 12.3">
          </div>
        </div>
        
        <label for="quantity">Кількість (тонни):</label>
        <input type="number" id="quantity" placeholder="Введіть кількість" required>
        
        <!-- Контейнер кнопок (Назад, Далі) -->
        <div class="button-container">
          <button id="backBtn2" type="button">Назад</button>
          <button id="nextBtn2" type="button">Далі</button>
        </div>
      </div>
      
      <!-- Крок 3: Ціна -->
      <div id="page3" class="hidden">
        <h2>Крок 3: Ціна</h2>
        <label for="price">Бажана ціна (не обов’язково):</label>
        <input type="text" id="price" placeholder="Введіть бажану ціну">
        
        <label for="currency">Вибір валюти:</label>
        <select id="currency" required>
          <option value="">Оберіть валюту</option>
          <option value="Грн">Грн</option>
          <option value="Долар">Долар</option>
          <option value="Євро">Євро</option>
        </select>
        
        <label for="paymentForm">Вибір форми оплати:</label>
        <select id="paymentForm" required>
          <option value="">Оберіть форму оплати</option>
        </select>
        
        <!-- Кнопки: Назад, Підтвердити -->
        <div class="button-container">
          <button id="backBtn3" type="button">Назад</button>
          <button id="submitBtn" type="button">Підтвердити заявку</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- AngularJS: модуль, контролери, директиви -->
  <script>
    angular.module('app', [])
      .directive('dropdownList', function() {
        return {
          restrict: 'E',
          require: 'ngModel',
          scope: {
            itemsList: '=',
            placeholder: '@',
            ngModel: '='
          },
          template: `
            <div class="dropdown-container">
              <input type="text" ng-model="searchText" placeholder="{{placeholder}}" ng-click="toggleList()" ng-focus="toggleList()" />
              <div class="dropdown-list" ng-show="listVisible">
                <div ng-repeat="item in itemsList | filter:searchText" ng-click="selectItem(item)">
                  {{item}}
                </div>
                <div ng-if="(itemsList | filter:searchText).length === 0" style="padding:8px;">
                  Нічого не знайдено
                </div>
              </div>
            </div>
          `,
          link: function(scope, element) {
            scope.listVisible = false;
            scope.searchText = scope.ngModel || '';
  
            scope.toggleList = function() {
              scope.listVisible = true;
            };
  
            scope.selectItem = function(item) {
              scope.ngModel = item;
              scope.searchText = item;
              scope.listVisible = false;
            };
  
            // Закриття списку при кліку поза компонентом
            document.addEventListener('click', function(e) {
              if (!element[0].contains(e.target)) {
                scope.$apply(function() {
                  scope.listVisible = false;
                });
              }
            });
          }
        };
      })
      // Директива formatDecimal
      .directive('formatDecimal', function() {
        return {
          require: 'ngModel',
          link: function(scope, element, attrs, ngModel) {
            var decimalRegex = /^\d+(?:[.,]\d)?$/;
            // Обмежуємо введення (тільки цифри + одна десяткова частина)
            element.on('keypress', function(e) {
              var char = String.fromCharCode(e.which);
              if (!/[0-9\.,]/.test(char)) {
                e.preventDefault();
                return false;
              }
              var currentVal = element.val();
              var selectionStart = element[0].selectionStart;
  
              // Якщо вже є роздільник, вдруге не вводимо
              if ((char === '.' || char === ',') && (currentVal.indexOf('.') !== -1 || currentVal.indexOf(',') !== -1)) {
                e.preventDefault();
                return false;
              }
              // Якщо вже є десяткова частина та курсор після роздільника, не даємо ввести більше 1 цифри
              var decIndex = currentVal.indexOf('.') !== -1 ? currentVal.indexOf('.') : currentVal.indexOf(',');
              if(decIndex !== -1 && selectionStart > decIndex) {
                var digitsAfter = currentVal.substring(decIndex + 1).length;
                var selectionEnd = element[0].selectionEnd;
                if(digitsAfter >= 1 && (selectionEnd - selectionStart) === 0) {
                  e.preventDefault();
                  return false;
                }
              }
            });
  
            // Валідатор
            ngModel.$validators.decimal = function(modelValue, viewValue) {
              var value = modelValue || viewValue;
              if (!value) return true; // пусто => ок
              value = value.replace(',', '.');
              return decimalRegex.test(value);
            };
  
            // Парсер: кому -> крапку
            ngModel.$parsers.push(function(value) {
              if (!value) return value;
              return value.replace(',', '.');
            });
  
            // Форматер: якщо немає крапки – додаємо ".0"
            ngModel.$formatters.push(function(value) {
              if (!value) return value;
              value = value.toString().replace(',', '.');
              if(value.indexOf('.') === -1) {
                return value + '.0';
              }
              return value;
            });
  
            // При blur додаємо ".0", якщо ввели ціле
            element.on('blur', function() {
              var value = ngModel.$modelValue;
              if (value && value.toString().indexOf('.') === -1) {
                ngModel.$setViewValue(value + '.0');
                ngModel.$render();
              }
            });
          }
        };
      })
      // Контролер для вибору локації
      .controller('mainCtrl', ['$scope', '$http', function($scope, $http) {
        $scope.selectedRegion = "";
        $scope.selectedDistrict = "";
        $scope.selectedCity = "";
        $scope.districts = [];
        $scope.cities = [];
  
        // Завантажуємо data.json
        $http.get('data.json')
          .then(function(response) {
            $scope.locationsData = response.data;
            $scope.regions = Object.keys($scope.locationsData);
          }, function(error) {
            console.error("Помилка завантаження даних:", error);
          });
  
        // Зміна області
        $scope.$watch('selectedRegion', function(newVal) {
          if(newVal && $scope.locationsData[newVal]) {
            $scope.districts = Object.keys($scope.locationsData[newVal]);
          } else {
            $scope.districts = [];
            $scope.selectedDistrict = "";
            $scope.cities = [];
            $scope.selectedCity = "";
          }
        });
  
        // Зміна району
        $scope.$watch('selectedDistrict', function(newVal) {
          if(newVal && $scope.selectedRegion && $scope.locationsData[$scope.selectedRegion][newVal]) {
            $scope.cities = $scope.locationsData[$scope.selectedRegion][newVal];
          } else {
            $scope.cities = [];
            $scope.selectedCity = "";
          }
        });
      }])
      // Контролер для кроку 2 (вибір групи, культури тощо)
      .controller('step2Ctrl', ['$scope', function($scope) {
        const cultureGroups = {
          "Зернова": [
            "Пшениця 2 кл.", "Пшениця 3 кл.", "Пшениця 4 кл.", "Ячмінь", "Кукурудза", "Овес", "Жито", "Кукурудза кремніста",
            "Пшениця тверда", "Тритикале", "Кукурудза фуражна", "Овес голозерний", "Кукурудза бита", "Кукурудза Зерноотход",
            "Кукурудза з підвищ. зерна", "Пшениця бита", "Пшениця спельта", "Пшениця неконд."
          ],
          "Олійна": [
            "Соняшник", "Соняшник високоолеїновий", "Ріпак", "Ріпак технічний", "Ріпак з ГМО", "Рапс ГМО"
          ],
          "Бобові": [
            "Соя з ГМО", "Горох жовтий", "Боби", "Горох зелений", "Соя без ГМО"
          ],
          "Продукти переробки": [
            "Олія соняшникова", "Макуха соняшникова високопрот.", "Шрот соняшник високопрот.", "Шрот соняшник низькопрот.",
            "Шрот соєвий", "Шрот ріпаку", "Отруби пшен. гран.", "Олія соєва", "Висівки пшеничні", "Макуха соєва",
            "Макуха ріпакова", "Цукор", "Олія ріпакова", "Шрот соняшн."
          ],
          "Нішеві культури": [
            "Сорго", "Сорго біле", "Сорго червоне", "Просо жовте", "Просо червоне", "Просо біле",
            "Гречка", "Нут", "Льон", "Віка", "Коріандр", "Сочевиця", "Спельта", "Сочевиця червона",
            "Льон золотистий", "Льон коричневий", "Просо чорне"
          ]
        };
  
        $scope.groups = Object.keys(cultureGroups).sort();
        $scope.selectedGroup = "";
        $scope.cultures = [];
        $scope.selectedCulture = "";
        $scope.extraFields = {};
  
        $scope.$watch('selectedGroup', function(newVal) {
          if(newVal){
            $scope.cultures = cultureGroups[newVal].slice().sort();
          } else {
            $scope.cultures = [];
            $scope.selectedCulture = "";
          }
        });
      }]);
  </script>
  
  <!-- Основна логіка (крок 1, 2, 3) + відправка -->
  <script>
    // Форми оплати залежно від валюти
    const paymentForms = {
      "Грн": ["Перерахунок з ПДВ", "Перерахунок без ПДВ", "Готівка"],
      "Долар": ["Валютний контракт", "Готівка"],
      "Євро": ["Валютний контракт"]
    };
  
    // При зміні валюти - підставляємо варіанти оплати
    document.getElementById("currency").addEventListener("change", function() {
      const currency = this.value;
      const paymentSelect = document.getElementById("paymentForm");
      paymentSelect.innerHTML = '<option value="">Оберіть форму оплати</option>';
      if(paymentForms[currency]) {
        paymentForms[currency].forEach(optionText => {
          const option = document.createElement("option");
          option.value = optionText;
          option.textContent = optionText;
          paymentSelect.appendChild(option);
        });
      }
    });
  
    // Фільтрація для ЄДРПОУ
    document.getElementById("edrpou").addEventListener("input", function() {
      this.value = this.value.replace(/\D/g, "");
    });
    
    // Фільтрація для бажаної ціни
    document.getElementById("price").addEventListener("input", function() {
      this.value = this.value.replace(/\D/g, "");
    });
    
    // Перехід: крок 1 -> крок 2
    document.getElementById("nextBtn1").addEventListener("click", function() {
      const edrpou = document.getElementById("edrpou").value;
      if(edrpou && !(edrpou.length === 8 || edrpou.length === 10)) {
        alert("Код ЄДРПОУ має містити 8 або 10 цифр (або бути порожнім).");
        return;
      }
      const locScope = angular.element(document.querySelector('[ng-controller="mainCtrl"]')).scope();
      if(!locScope.selectedRegion || !locScope.selectedDistrict || !locScope.selectedCity) {
        alert("Будь ласка, оберіть область, район і населений пункт!");
        return;
      }
      document.getElementById("page1").classList.add("hidden");
      document.getElementById("page2").classList.remove("hidden");
    });
    
    // Кнопка "Назад" на кроці 2
    document.getElementById("backBtn2").addEventListener("click", function() {
      document.getElementById("page2").classList.add("hidden");
      document.getElementById("page1").classList.remove("hidden");
    });
    
    // Перехід: крок 2 -> крок 3 (валидація)
    document.getElementById("nextBtn2").addEventListener("click", function() {
      const step2Scope = angular.element(document.querySelector('[ng-controller="step2Ctrl"]')).scope();
      if(!step2Scope.selectedGroup || !step2Scope.selectedCulture || !document.getElementById("quantity").value) {
        alert("Будь ласка, заповніть усі обов'язкові поля на цьому кроці!");
        return;
      }
      // Перевірка додаткових полів
      const extra = step2Scope.extraFields;
      const regex = /^\d+(?:[.,]\d)?$/;
      for(const key in extra) {
        if(extra.hasOwnProperty(key) && extra[key]) {
          const val = extra[key].toString().replace(',', '.');
          if(!regex.test(val)) {
            alert(`Некоректний формат у полі "${key}". Використовуйте формат XX.X (макс одна десяткова).`);
            return;
          }
        }
      }
      document.getElementById("page2").classList.add("hidden");
      document.getElementById("page3").classList.remove("hidden");
    });
    
    // Кнопка "Назад" на кроці 3
    document.getElementById("backBtn3").addEventListener("click", function() {
      document.getElementById("page3").classList.add("hidden");
      document.getElementById("page2").classList.remove("hidden");
    });
    
    // Відправка заявки
    document.getElementById("submitBtn").addEventListener("click", function() {
      if(!document.getElementById("currency").value || !document.getElementById("paymentForm").value) {
        alert("Будь ласка, оберіть валюту і форму оплати!");
        return;
      }
      
      const fghName   = document.getElementById("fghName").value.trim();
      const edrpou    = document.getElementById("edrpou").value.trim();
      const locScope  = angular.element(document.querySelector('[ng-controller="mainCtrl"]')).scope();
      const region    = locScope.selectedRegion;
      const district  = locScope.selectedDistrict;
      const city      = locScope.selectedCity;
      
      const step2Scope = angular.element(document.querySelector('[ng-controller="step2Ctrl"]')).scope();
      const group    = step2Scope.selectedGroup;
      const culture  = step2Scope.selectedCulture;
      const quantity = document.getElementById("quantity").value.trim();
      
      const price       = document.getElementById("price").value.trim();
      const currency    = document.getElementById("currency").value;
      const paymentForm = document.getElementById("paymentForm").value;
      
      // Telegram user_id (резервний, якщо не вийде)
      let userId = Telegram.WebApp.initDataUnsafe.user
        ? Telegram.WebApp.initDataUnsafe.user.id
        : 1124775269;
      
      const payload = {
        user_id: userId,
        fgh_name: fghName,
        edrpou: edrpou,
        region: region,
        district: district,
        city: city,
        group: group,
        culture: culture,
        quantity: quantity,
        price: price,
        currency: currency,
        payment_form: paymentForm,
        extra_fields: step2Scope.extraFields
      };
      
      console.log("Заявка заповнена. Payload:", payload);
      
      // Відправка в Telegram
      Telegram.WebApp.sendData(JSON.stringify(payload));
      
      // Відправка на ваш backend
      fetch("https://agro-api-url.onrender.com/api/webapp_data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        console.log("Отримано відповідь від API:", data);
        if(data.status === "ok" || data.status === "preview") {
          setTimeout(() => {
            Telegram.WebApp.close();
          }, 1000);
        } else {
          alert("Сталася помилка. Спробуйте ще раз.");
        }
      })
      .catch(error => {
        console.error("Помилка при відправленні даних:", error);
        alert("Помилка при відправленні даних. Спробуйте ще раз.");
      });
    });
    
    // (Опціонально) прокручувати форму при фокусі на полі
    document.querySelectorAll('input, select, textarea').forEach(el => {
      el.addEventListener('focus', () => {
        setTimeout(() => {
          // Можна manual scroll: 
          // const rect = el.getBoundingClientRect();
          // const top = rect.top + window.scrollY - 100;
          // window.scrollTo({ top, behavior: 'smooth' });
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      });
    });
    
    // Ініціалізація WebApp
    Telegram.WebApp.ready();
    console.log("WebApp готовий.");
  </script>
</body>
</html>
