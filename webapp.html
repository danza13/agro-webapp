<!DOCTYPE html>
<html lang="uk" ng-app="app">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Заповнення заявки – кроки</title>
  <!-- Підключення AngularJS -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: sans-serif;
      background: url('https://images.pexels.com/photos/730897/pexels-photo-730897.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=650&w=940') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      text-align: center;
    }
    .overlay {
      background-color: rgba(0,0,0,0.5);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
    }
    h2 { margin-bottom: 15px; }
    label { display: block; text-align: left; font-weight: bold; margin: 10px 0 5px; }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: none; box-sizing: border-box; font-size: 16px;
    }
    button { background: #007bff; color: #fff; cursor: pointer; transition: background 0.3s ease; }
    button:hover { background: #0056b3; }
    .hidden { display: none; }
    
    /* Стилі для директиви dropdownList */
    .dropdown-container {
      position: relative;
      text-align: left;
    }
    .dropdown-container input {
      background: #fff;
      color: #000;
    }
    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      color: #000;
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #ccc;
      z-index: 1000;
    }
    .dropdown-list div {
      padding: 8px;
      cursor: pointer;
    }
    .dropdown-list div:hover {
      background: #f0f0f0;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
</head>
<body>
  <div class="overlay">
    <div class="container">
      <!-- Крок 1: Основні дані -->
      <div id="page1">
        <h2>Крок 1: Основні дані</h2>
        <label for="fghName">Назва ФГ (не обов’язково):</label>
        <input type="text" id="fghName" placeholder="Введіть назву ФГ">
        
        <label for="edrpou">Код ЄДРПОУ (8 цифр, не обов’язково):</label>
        <input type="text" id="edrpou" placeholder="Введіть код ЄДРПОУ" pattern="^(\d{8})?$">
        
        <!-- Поля локації через AngularJS з директивою dropdownList -->
        <div ng-controller="mainCtrl">
          <label>Область:</label>
          <dropdown-list data-items-list="regions" data-placeholder="Оберіть область" ng-model="selectedRegion"></dropdown-list>
          
          <label>Район:</label>
          <dropdown-list data-items-list="districts" data-placeholder="Оберіть район" ng-model="selectedDistrict"></dropdown-list>
          
          <label>Населений пункт:</label>
          <dropdown-list data-items-list="cities" data-placeholder="Оберіть місто" ng-model="selectedCity"></dropdown-list>
        </div>
        
        <button id="nextBtn1">Далі</button>
      </div>
      
      <!-- Крок 2: Деталі заявки -->
      <div id="page2" class="hidden" ng-controller="step2Ctrl">
        <h2>Крок 2: Деталі заявки</h2>
        <label for="culture">Вибір культури:</label>
        <select id="culture" ng-model="selectedCulture" ng-change="updateGroups()" required>
          <option value="">Оберіть культуру</option>
          <option value="Зернова">Зернова</option>
          <option value="Олійна">Олійна</option>
          <option value="Бобові">Бобові</option>
          <option value="Продукти переробки">Продукти переробки</option>
          <option value="Нішеві культури">Нішеві культури</option>
        </select>
        
        <label>Вибір групи:</label>
        <dropdown-list data-items-list="groups" data-placeholder="Оберіть групу" ng-model="selectedGroup"></dropdown-list>
        
        <label for="quantity">Кількість (тонни):</label>
        <input type="number" id="quantity" placeholder="Введіть кількість" required>
        
        <button id="nextBtn2">Далі</button>
      </div>
      
      <!-- Крок 3: Оплата -->
      <div id="page3" class="hidden">
        <h2>Крок 3: Оплата</h2>
        <label for="price">Бажана ціна (не обов’язково):</label>
        <input type="text" id="price" placeholder="Введіть бажану ціну">
        
        <label for="currency">Вибір валюти:</label>
        <select id="currency" required>
          <option value="">Оберіть валюту</option>
          <option value="Грн">Грн</option>
          <option value="Долар">Долар</option>
          <option value="Євро">Євро</option>
        </select>
        
        <label for="form">Вибір форми:</label>
        <select id="form" required>
          <option value="">Оберіть форму</option>
        </select>
        
        <label for="paytype">Тип оплати:</label>
        <select id="paytype" required>
          <option value="">Оберіть тип оплати</option>
        </select>
        
        <button id="submitBtn">Підтвердити заявку</button>
      </div>
    </div>
  </div>
  
  <!-- AngularJS: модуль, контролери та директива dropdownList -->
  <script>
    angular.module('app', [])
      // Директива dropdownList із пошуком
      .directive('dropdownList', function() {
        return {
          restrict: 'E',
          require: 'ngModel',
          scope: {
            itemsList: '=',
            placeholder: '@',
            ngModel: '='
          },
          template: `
            <div class="dropdown-container">
              <input type="text" ng-model="searchText" placeholder="{{placeholder}}" ng-click="toggleList()" ng-focus="toggleList()" />
              <div class="dropdown-list" ng-show="listVisible">
                <div ng-repeat="item in itemsList | filter:searchText" ng-click="selectItem(item)">
                  {{item}}
                </div>
                <div ng-if="(itemsList | filter:searchText).length === 0" style="padding:8px;">Нічого не знайдено</div>
              </div>
            </div>
          `,
          link: function(scope, element, attrs) {
            scope.listVisible = false;
            scope.searchText = scope.ngModel || '';
  
            scope.toggleList = function() {
              scope.listVisible = true;
            };
  
            scope.selectItem = function(item) {
              scope.ngModel = item;
              scope.searchText = item;
              scope.listVisible = false;
            };
  
            document.addEventListener('click', function(e) {
              if (!element[0].contains(e.target)) {
                scope.$apply(function() {
                  scope.listVisible = false;
                });
              }
            });
          }
        };
      })
      // Контролер для локації
      .controller('mainCtrl', ['$scope', function($scope) {
        const locationsData = {
          "Київська область": {
            "Біла Церква": ["Біла Церква", "Сквира", "Кагарлик"],
            "Бровари": ["Бровари"],
            "Ірпінь": ["Ірпінь"]
          },
          "Львівська область": {
            "Львів": ["Львів"],
            "Дрогобицький район": ["Дрогобиць", "Невиць", "Броди"],
            "Сокальський район": ["Сокаль", "Копачів"]
          },
          "Одеська область": {
            "Одеса": ["Одеса"],
            "Ізмаїльський район": ["Ізмаїл", "Кілія"],
            "Білгород-Дністровський район": ["Білгород-Дністровський", "Енергодар"]
          }
        };
  
        $scope.regions = Object.keys(locationsData);
        $scope.selectedRegion = "";
        $scope.selectedDistrict = "";
        $scope.selectedCity = "";
        $scope.districts = [];
        $scope.cities = [];
  
        $scope.$watch('selectedRegion', function(newVal) {
          if(newVal && locationsData[newVal]) {
            $scope.districts = Object.keys(locationsData[newVal]);
          } else {
            $scope.districts = [];
            $scope.selectedDistrict = "";
            $scope.cities = [];
            $scope.selectedCity = "";
          }
        });
  
        $scope.$watch('selectedDistrict', function(newVal) {
          if(newVal && $scope.selectedRegion && locationsData[$scope.selectedRegion][newVal]) {
            $scope.cities = locationsData[$scope.selectedRegion][newVal];
          } else {
            $scope.cities = [];
            $scope.selectedCity = "";
          }
        });
      }])
      // Контролер для кроку 2: вибір культури та групи
      .controller('step2Ctrl', ['$scope', function($scope) {
        $scope.selectedCulture = "";
        $scope.groups = [];
        $scope.selectedGroup = "";
  
        const cultureGroups = {
          "Зернова": [
            "Пшениця 2 кл.", "Пшениця 3 кл.", "Пшениця 4 кл.", "Ячмінь", "Кукурудза", "Овес", "жито", "кукурудза кремніста",
            "Пшениця тверда", "Тритикале", "Кукурудза фуражна", "Овес голозерний", "Кукурудза бита", "кукурудза Зерноотход",
            "кукурудза з підвищ. зерна", "Пшениця бита", "Пшениця спельта", "Пшениця неконд."
          ],
          "Олійна": [
            "Соняшник", "Соняшник високоолеїновий", "Ріпак", "Ріпак технічний", "Ріпак з ГМО"
          ],
          "Бобові": [
            "Соя", "Гороох жовтий", "Боби", "Горох зелений", "Горох", "Соя без ГМО"
          ],
          "Продукти переробки": [
            "Олія соняшникова", "Макуха соняшникова високопрот.", "Шрот соняшник високопрот.", "Шрот соняшник. низькопрот.",
            "Шрот соєвий", "Шрот ріпаку", "Отруби пшен. гран.", "Олія соєва", "Висівки пшеничні", "Макуха соєва",
            "Макуха ріпакова", "Цукор", "Олія ріпакова", "Шрот соняшн."
          ],
          "Нішеві культури": [
            "Сорго", "Сорго біле", "Сорго червоне", "Просо жовте", "Просо червоне", "Просо біле",
            "Гречка", "Нут", "Льон", "Віка", "Коріандр", "Сочевиця", "Спельта", "Сочевиця червона",
            "Льон золотистий", "Льон коричневий", "Просо чорне"
          ]
        };
  
        $scope.updateGroups = function() {
          if($scope.selectedCulture && cultureGroups[$scope.selectedCulture]){
            $scope.groups = cultureGroups[$scope.selectedCulture];
          } else {
            $scope.groups = [];
            $scope.selectedGroup = "";
          }
        };
      }]);
  </script>
  
  <!-- Основна логіка WebApp для всіх кроків -->
  <script>
    /* --- Крок 3: Робота з оплатою --- */
    // Дані для форм оплати
    const formsData = {
      "Грн": ["Ф1", "Ф2", "Ф3"],
      "Долар": ["Ф1", "Ф2"],
      "Євро": ["Ф1"]
    };
  
    // Функція для отримання типів оплати залежно від валюти та форми
    function getPaytypes(currency, form) {
      if(form === "Ф1") {
        if(currency === "Грн") return ["Перерахунок з ПДВ"];
        if(currency === "Долар" || currency === "Євро") return ["Валютний контракт"];
      }
      if(form === "Ф2") {
        if(currency === "Грн" || currency === "Долар") return ["Готівка"];
      }
      if(form === "Ф3") {
        if(currency === "Грн") return ["Перерахунок без ПДВ"];
      }
      return [];
    }
  
    // Оновлення списку форм при зміні валюти
    document.getElementById("currency").addEventListener("change", function() {
      const currency = this.value;
      const formSelect = document.getElementById("form");
      formSelect.innerHTML = '<option value="">Оберіть форму</option>';
      if(formsData[currency]) {
        formsData[currency].forEach(function(form) {
          const option = document.createElement("option");
          option.value = form;
          option.textContent = form;
          formSelect.appendChild(option);
        });
      }
      // Очищення типів оплати
      document.getElementById("paytype").innerHTML = '<option value="">Оберіть тип оплати</option>';
    });
  
    // Оновлення списку типів оплати при зміні форми
    document.getElementById("form").addEventListener("change", function() {
      const currency = document.getElementById("currency").value;
      const form = this.value;
      const paytypeSelect = document.getElementById("paytype");
      paytypeSelect.innerHTML = '<option value="">Оберіть тип оплати</option>';
      const types = getPaytypes(currency, form);
      types.forEach(function(type) {
        const option = document.createElement("option");
        option.value = type;
        option.textContent = type;
        paytypeSelect.appendChild(option);
      });
    });
  
    /* --- Решта логіки (кроки, відправка, prefill тощо) --- */
  
    document.getElementById("edrpou").addEventListener("input", function() {
      this.value = this.value.replace(/\D/g, "");
    });
    
    document.getElementById("price").addEventListener("input", function() {
      this.value = this.value.replace(/\D/g, "");
    });
    
    document.getElementById("nextBtn1").addEventListener("click", function() {
      const edrpou = document.getElementById("edrpou").value;
      if(edrpou && edrpou.length !== 8) {
        alert("Код ЄДРПОУ повинен містити 8 цифр або бути порожнім.");
        return;
      }
      var scope = angular.element(document.querySelector('[ng-controller="mainCtrl"]')).scope();
      if(!scope.selectedRegion || !scope.selectedDistrict || !scope.selectedCity) {
        alert("Будь ласка, оберіть усі обов'язкові поля для локації!");
        return;
      }
      document.getElementById("page1").classList.add("hidden");
      document.getElementById("page2").classList.remove("hidden");
    });
    
    document.getElementById("nextBtn2").addEventListener("click", function() {
      var scope = angular.element(document.querySelector('[ng-controller="step2Ctrl"]')).scope();
      if(!scope.selectedCulture || !scope.selectedGroup || !document.getElementById("quantity").value) {
        alert("Будь ласка, заповніть усі обов'язкові поля на цьому кроці!");
        return;
      }
      document.getElementById("page2").classList.add("hidden");
      document.getElementById("page3").classList.remove("hidden");
    });
    
    document.getElementById("submitBtn").addEventListener("click", function() {
      if(!document.getElementById("currency").value || !document.getElementById("form").value || !document.getElementById("paytype").value) {
        alert("Будь ласка, заповніть усі обов'язкові поля на цьому кроці!");
        return;
      }
      
      const fghName   = document.getElementById("fghName").value.trim();
      const edrpou    = document.getElementById("edrpou").value.trim();
      var locScope = angular.element(document.querySelector('[ng-controller="mainCtrl"]')).scope();
      const region    = locScope.selectedRegion;
      const district  = locScope.selectedDistrict;
      const city      = locScope.selectedCity;
      
      const culture   = document.getElementById("culture").value;
      var step2Scope = angular.element(document.querySelector('[ng-controller="step2Ctrl"]')).scope();
      const group     = step2Scope.selectedGroup;
      const quantity  = document.getElementById("quantity").value.trim();
      
      const price     = document.getElementById("price").value.trim();
      const currency  = document.getElementById("currency").value;
      const form      = document.getElementById("form").value;
      const paytype   = document.getElementById("paytype").value;
      
      let userId = Telegram.WebApp.initDataUnsafe.user ? Telegram.WebApp.initDataUnsafe.user.id : 1124775269;
      
      const payload = {
        user_id: userId,
        fgh_name: fghName,
        edrpou: edrpou,
        region: region,
        district: district,
        city: city,
        culture: culture,
        group: group,
        quantity: quantity,
        price: price,
        currency: currency,
        form: form,
        paytype: paytype
      };
      
      console.log("Заявка заповнена. Payload:", payload);
      
      Telegram.WebApp.sendData(JSON.stringify(payload));
      
      fetch("https://agro-api-url.onrender.com/api/webapp_data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        console.log("Отримано відповідь від API:", data);
        if(data.status === "ok" || data.status === "preview") {
          setTimeout(() => {
            Telegram.WebApp.close();
          }, 1000);
        } else {
          alert("Сталася помилка. Спробуйте ще раз.");
        }
      })
      .catch(error => {
        console.error("Помилка при відправленні даних:", error);
        alert("Помилка при відправленні даних. Спробуйте ще раз.");
      });
    });
    
    Telegram.WebApp.ready();
    console.log("WebApp готовий.");
  </script>
</body>
</html>
