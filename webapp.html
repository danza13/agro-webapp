<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Вибір культури та геоданих</title>
  <style>
    /* ... ваш CSS код без змін ... */
  </style>
</head>
<body>
<div class="overlay">
  <div class="container">
    <h2>Оберіть дані</h2>
    <label for="cultureInput">Культура:</label>
    <input type="text" id="cultureInput" placeholder="Введіть культуру" list="cultureList">
    <datalist id="cultureList">
      <!-- Опції завантажуються -->
    </datalist>
    <label for="regionInput">Область:</label>
    <input type="text" id="regionInput" placeholder="Введіть область" list="regionList">
    <datalist id="regionList">
      <!-- Опції завантажуються -->
    </datalist>
    <label for="districtInput">Район:</label>
    <input type="text" id="districtInput" placeholder="Введіть район">
    <label for="cityInput">Населений пункт:</label>
    <input type="text" id="cityInput" placeholder="Введіть населенець">
    <button id="submitBtn">Підтвердити</button>
  </div>
</div>

<!-- Підключення Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  Telegram.WebApp.expand();

  const CULTURES_URL = "https://raw.githubusercontent.com/danza13/data/main/cultures.json";
  const LOCATIONS_URL = "https://raw.githubusercontent.com/danza13/data/main/locations.json";

  let cultures = [];
  let regions = [];
  let locations = {};

  async function loadData(url) {
    const response = await fetch(url);
    return await response.json();
  }

  async function initData() {
    try {
      const culturesData = await loadData(CULTURES_URL);
      cultures = culturesData.cultures || [];
      updateDatalist("cultureInput", "cultureList", cultures);
    } catch (e) {
      console.error("Помилка завантаження культур:", e);
    }

    try {
      const locationsData = await loadData(LOCATIONS_URL);
      locations = locationsData["області"] || {};
      regions = Object.keys(locations);
      updateDatalist("regionInput", "regionList", regions);
    } catch (e) {
      console.error("Помилка завантаження локацій:", e);
    }
  }

  function updateDatalist(inputId, datalistId, dataArray) {
    const input = document.getElementById(inputId);
    const datalist = document.getElementById(datalistId);
    const filter = input.value.toLowerCase();
    datalist.innerHTML = "";
    dataArray.filter(item => item.toLowerCase().includes(filter))
             .forEach(item => {
               const option = document.createElement("option");
               option.value = item;
               datalist.appendChild(option);
             });
  }

  document.getElementById('cultureInput').addEventListener('input', () => {
    updateDatalist("cultureInput", "cultureList", cultures);
  });
  document.getElementById('regionInput').addEventListener('input', () => {
    updateDatalist("regionInput", "regionList", regions);
  });

  initData();

  document.getElementById('submitBtn').addEventListener('click', () => {
    const culture = document.getElementById('cultureInput').value.trim();
    const region = document.getElementById('regionInput').value.trim();
    const district = document.getElementById('districtInput').value.trim();
    const city = document.getElementById('cityInput').value.trim();

    if (!culture || !region || !district || !city) {
      alert("Будь ласка, заповніть усі поля!");
      return;
    }

    const userId = Telegram.WebApp.initDataUnsafe.user ? Telegram.WebApp.initDataUnsafe.user.id : null;
    const payload = {
      user_id: userId,
      culture,
      region,
      district,
      city
    };

    console.log("Надсилаємо payload:", payload);

    Telegram.WebApp.sendData(JSON.stringify(payload));

    // Затримка 1000 мс перед закриттям, щоб впевнитися, що дані надіслано
    setTimeout(() => {
      Telegram.WebApp.close();
    }, 1000);
  });
</script>
</body>
</html>
